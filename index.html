<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Codestral</title>
    
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Monaco Editor (VS Code's core) Loader -->
    <script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.44.0/min/vs/loader.js"></script>
    
    <!-- Google Fonts and Icons -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&family=Hack&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" rel="stylesheet" />

    <style>
        /* Custom styles for the app */
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #111827; /* Dark background */
            color: #f3f4f6;
            margin: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden; /* Prevent body scroll */
        }
        .banner {
            width: 100%;
            background-color: #1f2937;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
            height: 60px;
            border-bottom: 1px solid #374151;
            flex-shrink: 0;
        }
        .banner-logo {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: bold;
            font-size: 1.2rem;
            color: white;
        }
        #app-container {
            flex-grow: 1;
            overflow: hidden; /* Main container hidden overflow */
            position: relative;
            display: flex;
            flex-direction: column;
        }
        .monaco-editor {
            font-family: 'Hack', monospace;
        }
        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
            vertical-align: middle;
        }
        .filled-icon {
            font-variation-settings: 'FILL' 1, 'wght' 400, 'GRAD' 0, 'opsz' 24;
        }
        /* Scrollbars */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1f2937;
        }
        ::-webkit-scrollbar-thumb {
            background: #4b5563;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #6b7280;
        }
        /* Spinner */
        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            border-top-color: #3b82f6;
            width: 20px;
            height: 20px;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Drive Grid Styles */
        .drive-grid {
            /* Asegura que el grid ocupe el 100% de la altura de su contenedor flex para que el overflow-y funcione. */
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 1rem;
            padding: 1rem;
            overflow-y: auto; /* Habilitar scroll vertical */
            height: 100%;
        }

        .drive-item {
            background-color: #1f2937;
            border: 1px solid #374151;
            border-radius: 8px;
            padding: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            user-select: none;
            position: relative;
        }
        .drive-item:hover {
            background-color: #374151;
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .drive-item.folder-drag-over {
            border: 2px dashed #3b82f6;
            background-color: #2563eb33;
        }
        .drive-item .icon {
            font-size: 48px;
            margin-bottom: 8px;
        }
        .drive-item .folder-icon { color: #60a5fa; }
        .drive-item .html-icon { color: #e44d26; }
        .drive-item .js-icon { color: #f7df1e; }
        .drive-item .css-icon { color: #264de4; }
        .drive-item .py-icon { color: #306998; }
        .drive-item .md-icon { color: #ffffff; }

        .drive-item .name {
            text-align: center;
            font-size: 0.9rem;
            color: #e5e7eb;
            width: 100%;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .context-menu-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            opacity: 0;
            transition: opacity 0.2s;
            padding: 2px;
            border-radius: 4px;
        }
        .drive-item:hover .context-menu-btn {
            opacity: 1;
        }
        .context-menu-btn:hover {
            background-color: rgba(255,255,255,0.1);
        }

        /* Breadcrumb */
        .breadcrumb-item:not(:last-child):after {
            content: 'chevron_right';
            font-family: 'Material Symbols Outlined';
            font-size: 16px;
            vertical-align: middle;
            margin: 0 4px;
            color: #9ca3af;
        }
        .breadcrumb-item:hover {
            color: #60a5fa;
            text-decoration: underline;
        }

        /* Context Menu */
        #context-menu {
            position: fixed;
            z-index: 100;
            width: 150px;
            background: #1f2937;
            border: 1px solid #374151;
            border-radius: 6px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            display: none;
        }
        .context-menu-option {
            padding: 8px 12px;
            cursor: pointer;
            font-size: 0.9rem;
            color: #e5e7eb;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .context-menu-option:hover {
            background-color: #374151;
            color: white;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100">

    <div id="initial-loading" class="h-screen w-screen flex items-center justify-center absolute z-50 bg-gray-900">
        <div class="spinner" style="width: 48px; height: 48px; border-width: 5px;"></div>
    </div>

    <!-- Top Banner (Visible in Dashboard and Editor) -->
    <div id="top-banner" class="banner hidden">
        <div class="banner-logo cursor-pointer" id="logo-btn">
            <span class="material-symbols-outlined text-blue-500 text-3xl">terminal</span>
            <span>Codestral</span>
        </div>
        <div class="flex items-center gap-4">
            <div id="user-info-name" class="text-sm font-medium text-gray-300 hidden sm:block"></div>
            <button id="logout-btn" class="text-xs bg-red-600/20 hover:bg-red-600/40 text-red-200 border border-red-600/30 px-3 py-1.5 rounded transition-colors">Salir</button>
        </div>
    </div>

    <!-- Main App Container -->
    <div id="app-container" class="hidden w-full">

        <!-- Login View -->
        <div id="login-view" class="hidden h-full flex items-center justify-center bg-gray-900 absolute inset-0 z-40">
            <div class="w-full max-w-md p-8 space-y-8 bg-gray-800 rounded-xl shadow-2xl border border-gray-700">
                <div class="text-center">
                    <span class="material-symbols-outlined text-blue-500 text-6xl mb-4">terminal</span>
                    <h2 id="auth-title" class="text-3xl font-bold tracking-tight text-white">Bienvenido</h2>
                    <p class="text-gray-400 mt-2">¡Bienvenid@ a Codestral!</p>
                </div>
                <form id="login-form" class="mt-8 space-y-5">
                    <div class="space-y-4">
                        <input id="username" name="username" type="text" required class="block w-full rounded-md border border-gray-600 bg-gray-900 px-4 py-3 text-white placeholder-gray-500 focus:border-blue-500 focus:ring-blue-500 sm:text-sm" placeholder="Nombre de usuario">
                        <input id="password" name="password" type="password" required class="block w-full rounded-md border border-gray-600 bg-gray-900 px-4 py-3 text-white placeholder-gray-500 focus:border-blue-500 focus:ring-blue-500 sm:text-sm" placeholder="Contraseña">
                    </div>
                    <button id="auth-button" type="submit" class="group relative flex w-full justify-center rounded-md border border-transparent bg-blue-600 py-3 text-sm font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 focus:ring-offset-gray-800">
                        Acceder
                    </button>
                    <div class="text-sm text-center">
                        <a href="#" id="toggle-auth-mode" class="font-medium text-blue-400 hover:text-blue-300 transition-colors">¿No tienes cuenta? Regístrate</a>
                    </div>
                </form>
            </div>
        </div>

        <!-- Dashboard / Drive View -->
        <div id="dashboard-view" class="hidden flex flex-col h-full">
            <!-- Toolbar -->
            <div class="bg-gray-800 border-b border-gray-700 p-3 flex flex-col sm:flex-row justify-between items-center gap-3">
                
                <!-- Breadcrumbs & Nav -->
                <div class="flex items-center gap-3 w-full sm:w-auto overflow-x-auto">
                    <button id="nav-home-btn" class="p-1.5 hover:bg-gray-700 rounded text-gray-300 hover:text-white transition-colors" title="Inicio">
                        <span class="material-symbols-outlined">home</span>
                    </button>
                    <div id="breadcrumbs" class="flex items-center text-sm font-mono text-gray-300 whitespace-nowrap">
                        <!-- Breadcrumbs injected here -->
                        <span class="breadcrumb-item cursor-pointer hover:text-blue-400">Inicio</span>
                    </div>
                </div>

                <!-- Actions -->
                <div class="flex items-center gap-2">
                    <div class="relative group">
                        <button class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-1.5 px-4 rounded-md shadow-sm transition-all flex items-center gap-2 text-sm">
                            <span class="material-symbols-outlined text-lg">add</span> Nuevo
                        </button>
                        <!-- Dropdown Menu - FIX: Removed mt-1 to prevent premature closing on mouse drag down -->
                        <div class="absolute right-0 top-full w-48 bg-gray-800 border border-gray-700 rounded-md shadow-xl hidden group-hover:block z-20">
                            <div class="py-1">
                                <button id="new-folder-btn" class="w-full text-left px-4 py-2 text-sm text-gray-300 hover:bg-gray-700 hover:text-white flex items-center gap-2">
                                    <span class="material-symbols-outlined text-gray-400">folder</span> Carpeta
                                </button>
                                <button id="new-project-btn" class="w-full text-left px-4 py-2 text-sm text-gray-300 hover:bg-gray-700 hover:text-white flex items-center gap-2">
                                    <span class="material-symbols-outlined text-gray-400">code</span> Proyecto
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tabs (My Drive / Shared) -->
            <div class="bg-gray-800 border-b border-gray-700 px-4">
                <nav class="flex space-x-6">
                    <button id="tab-my-drive" class="border-b-2 border-blue-500 py-3 text-sm font-medium text-blue-400 focus:outline-none">Mi Unidad</button>
                    <button id="tab-shared" class="border-b-2 border-transparent py-3 text-sm font-medium text-gray-400 hover:border-gray-600 hover:text-gray-300 focus:outline-none">Compartidos</button>
                </nav>
            </div>

            <!-- Drive Grid Area -->
            <div id="drive-area" class="flex-grow bg-gray-900 relative">
                <div id="drive-grid" class="drive-grid">
                    <!-- Folders and Files injected here -->
                </div>
                <!-- Empty State -->
                <div id="empty-state" class="hidden absolute inset-0 flex flex-col items-center justify-center text-gray-500 select-none pointer-events-none">
                    <span class="material-symbols-outlined text-6xl mb-2 opacity-50">cloud_off</span>
                    <p>Esta carpeta está vacía</p>
                </div>
            </div>
        </div>

        <!-- Editor View -->
        <div id="editor-view" class="hidden h-full flex flex-col bg-gray-900">
            <header class="bg-gray-800 p-2 border-b border-gray-700 flex items-center justify-between shadow-sm flex-shrink-0 z-10">
                <div class="flex items-center gap-3 overflow-hidden">
                    <button id="back-to-dashboard" class="flex items-center justify-center w-8 h-8 rounded hover:bg-gray-700 text-gray-400 hover:text-white transition-colors">
                        <span class="material-symbols-outlined">arrow_back</span>
                    </button>
                    <div class="flex flex-col">
                        <h2 id="editor-title" class="text-sm font-semibold text-white truncate max-w-[200px]"></h2>
                        <span id="editor-status" class="text-xs text-gray-500">Guardado</span>
                    </div>
                </div>
                
                <div class="flex items-center gap-2">
                     <button id="preview-new-tab-btn" class="hidden sm:flex items-center gap-1 bg-gray-700 hover:bg-gray-600 text-gray-300 text-xs py-1.5 px-3 rounded transition-colors border border-gray-600">
                        <span class="material-symbols-outlined text-sm">open_in_new</span>
                        <span>Abrir Web</span>
                    </button>
                </div>
            </header>

            <!-- AI Bar -->
            <div class="bg-gray-800/50 p-2 border-b border-gray-700 flex items-center gap-2 flex-shrink-0 backdrop-blur-sm">
                <div class="relative flex-grow">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <span class="material-symbols-outlined text-gray-500 text-sm">auto_awesome</span>
                    </div>
                    <input type="text" id="ai-prompt" placeholder="Pídele a la IA que edite o explique el código..." class="block w-full pl-10 pr-12 py-1.5 bg-gray-900 border border-gray-700 rounded-md text-sm text-white placeholder-gray-500 focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500 transition-all">
                    
                    <div class="absolute inset-y-0 right-0 flex items-center pr-1">
                        <button id="ai-settings-toggle" class="p-1 text-gray-400 hover:text-white hover:bg-gray-700 rounded transition-colors">
                            <span class="material-symbols-outlined text-sm">tune</span>
                        </button>
                        <div id="ai-loading-spinner" class="hidden ml-1 mr-1">
                            <div class="spinner w-4 h-4 border-2"></div>
                        </div>
                    </div>

                    <!-- AI Settings Dropdown -->
                    <div id="ai-settings-dropdown" class="absolute right-0 top-full mt-2 w-64 bg-gray-800 border border-gray-700 rounded-md shadow-xl z-50 hidden p-3">
                        <h4 class="text-xs font-semibold text-gray-400 uppercase mb-2">Configuración IA</h4>
                        <label class="flex items-center gap-2 cursor-pointer group">
                            <input type="checkbox" id="ai-diff-mode-checkbox" class="form-checkbox h-4 w-4 text-blue-600 bg-gray-900 border-gray-600 rounded focus:ring-blue-500">
                            <span class="text-sm text-gray-300 group-hover:text-white transition-colors">Modo Diff (Aprobar cambios)</span>
                        </label>
                    </div>
                </div>
            </div>

            <!-- Main Editor Area -->
            <main class="flex-grow flex flex-col md:flex-row overflow-hidden relative">
                <div id="editor-container" class="w-full md:w-1/2 h-1/2 md:h-full relative"></div>
                <!-- Resizer handle could go here -->
                <div id="preview-container" class="w-full md:w-1/2 h-1/2 md:h-full bg-white border-t md:border-t-0 md:border-l border-gray-700 relative">
                     <div class="absolute top-0 right-0 bg-gray-100 text-gray-500 text-[10px] px-2 py-1 z-10 opacity-50 hover:opacity-100 pointer-events-none">PREVIEW</div>
                    <iframe id="preview-iframe" class="w-full h-full border-0 bg-white" sandbox="allow-scripts allow-modals allow-same-origin"></iframe>
                </div>
            </main>
        </div>
    </div>

    <!-- Modals -->
    <!-- Input Modal -->
    <div id="custom-modal" class="hidden fixed inset-0 bg-black/70 backdrop-blur-sm z-[100] flex items-center justify-center p-4">
        <div class="bg-gray-800 rounded-xl shadow-2xl p-6 w-full max-w-md border border-gray-700 transform transition-all scale-100">
            <h3 id="modal-title" class="text-lg font-bold text-white mb-2">Título</h3>
            <p id="modal-message" class="text-sm text-gray-300 mb-4">Mensaje</p>
            
            <!-- Diff View inside Modal -->
            <div id="modal-diff-container" class="hidden bg-gray-900 rounded border border-gray-700 p-3 max-h-60 overflow-y-auto mb-4 font-mono text-xs">
                <code id="modal-diff-content"></code>
            </div>

            <!-- Create Project Form (Dynamic) -->
            <div id="modal-form-container" class="hidden mb-4 space-y-3">
                <input type="text" id="modal-input" class="w-full bg-gray-900 text-white placeholder-gray-500 rounded border border-gray-600 px-3 py-2 focus:ring-1 focus:ring-blue-500 focus:outline-none transition-all">
                <select id="modal-select" class="hidden w-full bg-gray-900 text-white rounded border border-gray-600 px-3 py-2 focus:ring-1 focus:ring-blue-500 focus:outline-none">
                    <option value="html">HTML5 Web</option>
                    <option value="javascript">JavaScript</option>
                    <option value="css">CSS Stylesheet</option>
                    <option value="python">Python Script</option>
                    <option value="markdown">Markdown Doc</option>
                </select>
            </div>

            <div class="flex justify-end gap-3 mt-6">
                <button id="modal-cancel-btn" class="px-4 py-2 rounded text-sm text-gray-300 hover:bg-gray-700 hover:text-white transition-colors">Cancelar</button>
                <button id="modal-confirm-btn" class="px-4 py-2 rounded text-sm bg-blue-600 hover:bg-blue-700 text-white font-medium shadow-sm transition-colors">Confirmar</button>
            </div>
        </div>
    </div>

    <!-- Context Menu -->
    <div id="context-menu">
        <div class="context-menu-option" id="ctx-open">
            <span class="material-symbols-outlined text-sm">open_in_new</span> Abrir
        </div>
        <div class="context-menu-option" id="ctx-move">
            <span class="material-symbols-outlined text-sm">drive_file_move</span> Mover...
        </div>
        <div class="border-t border-gray-700 my-1"></div>
        <div class="context-menu-option text-red-400 hover:text-red-300" id="ctx-delete">
            <span class="material-symbols-outlined text-sm">delete</span> Eliminar
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getDatabase, ref, set, onValue, push, remove, get, update } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // --- CONSTANTS & CONFIG ---
        const SYSTEM_PROMPT_REPLACE = (lang) => `Eres un asistente de código experto. Devuelve SOLO el código completo corregido en formato Markdown para ${lang}. Sin explicaciones.`;
        const SYSTEM_PROMPT_DIFF = `Eres un asistente de código. Identifica cambios. Devuelve SOLO un array JSON: [{"originalLine":"...","editedLine":"..."},...]`;

        const firebaseConfig = {
          apiKey: "AIzaSyAP7a8L45teU-bW7aLG7wG6WAlW4YlWCXE",
          authDomain: "weberiawebs.firebaseapp.com",
          databaseURL: "https://weberiawebs-default-rtdb.europe-west1.firebasedatabase.app",
          projectId: "weberiawebs",
          storageBucket: "weberiawebs.appspot.com",
          messagingSenderId: "1010989728559",
          appId: "1:1010989728559:web:85538155fc4473809057da",
          measurementId: "G-HL18KF992B"
        };

        // --- APP STATE ---
        let db, auth, currentUser;
        let monacoEditor = null;
        let currentProgramId = null;
        let currentProgramOwner = null;
        let currentLang = 'html';
        
        // Drive State
        let currentFolderId = 'root';
        let breadcrumbPath = [{ id: 'root', name: 'Inicio' }];
        let cachedFolders = {};
        let cachedProjects = {};
        let activeTab = 'my'; // 'my' or 'shared'
        let clipboardMove = null; // { id, type, sourceFolder }

        // --- DOM ELEMENTS ---
        const dom = {
            loading: document.getElementById('initial-loading'),
            banner: document.getElementById('top-banner'),
            app: document.getElementById('app-container'),
            loginView: document.getElementById('login-view'),
            dashboardView: document.getElementById('dashboard-view'),
            editorView: document.getElementById('editor-view'),
            driveGrid: document.getElementById('drive-grid'),
            breadcrumbs: document.getElementById('breadcrumbs'),
            emptyState: document.getElementById('empty-state'),
            tabMy: document.getElementById('tab-my-drive'),
            tabShared: document.getElementById('tab-shared'),
            editorTitle: document.getElementById('editor-title'),
            editorContainer: document.getElementById('editor-container'),
            previewContainer: document.getElementById('preview-container'),
            previewIframe: document.getElementById('preview-iframe'),
            modal: document.getElementById('custom-modal'),
            contextMenu: document.getElementById('context-menu')
        };

        // --- INITIALIZATION ---
        try {
            const app = initializeApp(firebaseConfig);
            db = getDatabase(app);
            auth = getAuth(app);
            setupAuthListener();
        } catch (e) {
            console.error("Firebase Init Error:", e);
            showAlert("Error crítico iniciando la base de datos.");
        }

        // --- AUTH LOGIC ---
        function setupAuthListener() {
            onAuthStateChanged(auth, (user) => {
                dom.loading.classList.add('hidden');
                dom.app.classList.remove('hidden');
                
                if (user) {
                    currentUser = user;
                    document.getElementById('user-info-name').textContent = user.displayName || user.email;
                    dom.loginView.classList.add('hidden');
                    showDashboard();
                } else {
                    currentUser = null;
                    dom.banner.classList.add('hidden');
                    dom.dashboardView.classList.add('hidden');
                    dom.editorView.classList.add('hidden');
                    dom.loginView.classList.remove('hidden');
                }
            });
        }

        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const u = document.getElementById('username').value.trim();
            const p = document.getElementById('password').value;
            const email = `${u.toLowerCase()}@weberia.app`;
            const isRegister = document.getElementById('auth-button').textContent === 'Registrarse';

            try {
                if (isRegister) {
                    const checkRef = ref(db, `usernames/${u.toLowerCase()}`);
                    const checkSnap = await get(checkRef);
                    if (checkSnap.exists()) throw new Error("El usuario ya existe.");
                    
                    const cred = await createUserWithEmailAndPassword(auth, email, p);
                    await updateProfile(cred.user, { displayName: u });
                    await update(ref(db), {
                        [`users/${cred.user.uid}/profile`]: { displayName: u, createdAt: new Date().toISOString() },
                        [`usernames/${u.toLowerCase()}`]: cred.user.uid
                    });
                } else {
                    await signInWithEmailAndPassword(auth, email, p);
                }
            } catch (err) {
                showAlert('Error de Autenticación', err.message.replace('Firebase:', '').trim());
            }
        });

        document.getElementById('toggle-auth-mode').addEventListener('click', (e) => {
            e.preventDefault();
            const btn = document.getElementById('auth-button');
            const title = document.getElementById('auth-title');
            const link = document.getElementById('toggle-auth-mode');
            if (btn.textContent === 'Acceder') {
                btn.textContent = 'Registrarse';
                title.textContent = 'Crear Cuenta';
                link.innerHTML = '¿Ya tienes cuenta? <span class="text-blue-400">Inicia sesión</span>';
            } else {
                btn.textContent = 'Acceder';
                title.textContent = 'Bienvenido';
                link.innerHTML = '¿No tienes cuenta? <span class="text-blue-400">Regístrate</span>';
            }
        });

        document.getElementById('logout-btn').addEventListener('click', () => signOut(auth));

        // --- NAVIGATION & DASHBOARD ---
        function showDashboard() {
            dom.banner.classList.remove('hidden');
            dom.dashboardView.classList.remove('hidden');
            dom.editorView.classList.add('hidden');
            dom.app.style.height = 'calc(100vh - 60px)';
            
            if (monacoEditor) {
                monacoEditor.dispose();
                monacoEditor = null;
            }
            
            currentProgramId = null; // Clear active program ID
            currentFolderId = 'root';
            breadcrumbPath = [{ id: 'root', name: 'Inicio' }];
            activeTab = 'my';
            updateTabs();
            loadDriveContent();
        }

        function updateTabs() {
            if (activeTab === 'my') {
                dom.tabMy.classList.add('border-blue-500', 'text-blue-400');
                dom.tabMy.classList.remove('border-transparent', 'text-gray-400');
                dom.tabShared.classList.remove('border-blue-500', 'text-blue-400');
                dom.tabShared.classList.add('border-transparent', 'text-gray-400');
            } else {
                dom.tabShared.classList.add('border-blue-500', 'text-blue-400');
                dom.tabShared.classList.remove('border-transparent', 'text-gray-400');
                dom.tabMy.classList.remove('border-blue-500', 'text-blue-400');
                dom.tabMy.classList.add('border-transparent', 'text-gray-400');
            }
        }

        document.getElementById('tab-my-drive').addEventListener('click', () => {
            activeTab = 'my';
            currentFolderId = 'root';
            breadcrumbPath = [{ id: 'root', name: 'Inicio' }];
            updateTabs();
            loadDriveContent();
        });

        document.getElementById('tab-shared').addEventListener('click', () => {
            activeTab = 'shared';
            updateTabs();
            loadSharedContent();
        });

        // --- DRIVE LOGIC (CORE) ---
        function loadDriveContent() {
            if (!currentUser) return;
            
            // Render Breadcrumbs
            renderBreadcrumbs();

            // Setup Listeners
            const foldersRef = ref(db, `users/${currentUser.uid}/folders`);
            const projectsRef = ref(db, `users/${currentUser.uid}/projects`);

            // Use onValue to get real-time updates
            onValue(foldersRef, (snapF) => {
                cachedFolders = snapF.val() || {};
                // Nested onValue for projects ensures we have both caches before rendering.
                onValue(projectsRef, (snapP) => {
                    cachedProjects = snapP.val() || {};
                    renderGrid();
                }, { onlyOnce: true }); // optimize nesting, though for real-time app, often removed.
            });
        }

        function loadSharedContent() {
            if (!currentUser) return;
            dom.breadcrumbs.innerHTML = '<span class="text-gray-400">Compartidos conmigo</span>';
            const sharedRef = ref(db, `sharedWith/${currentUser.uid}`);
            onValue(sharedRef, async (snap) => {
                dom.driveGrid.innerHTML = '';
                const data = snap.val();
                if (!data) {
                    dom.emptyState.classList.remove('hidden');
                    return;
                }
                dom.emptyState.classList.add('hidden');
                
                // Fetch details for each shared project
                const promises = Object.keys(data).map(async (pid) => {
                    const ownerId = data[pid].owner;
                    const pSnap = await get(ref(db, `users/${ownerId}/projects/${pid}`));
                    if (pSnap.exists()) return { ...pSnap.val(), id: pid, owner: ownerId, isShared: true };
                    return null;
                });

                const projects = (await Promise.all(promises)).filter(p => p);
                projects.forEach(p => dom.driveGrid.appendChild(createDriveItem(p, 'file')));
            });
        }

        function renderBreadcrumbs() {
            dom.breadcrumbs.innerHTML = '';
            breadcrumbPath.forEach((step, index) => {
                const span = document.createElement('span');
                span.className = 'breadcrumb-item cursor-pointer hover:text-blue-400';
                span.textContent = step.name;
                span.onclick = () => {
                    // Navigate to this step
                    currentFolderId = step.id;
                    breadcrumbPath = breadcrumbPath.slice(0, index + 1);
                    renderGrid(); // Just re-render based on new ID
                    renderBreadcrumbs();
                };
                dom.breadcrumbs.appendChild(span);
            });
        }

        function renderGrid() {
            if (activeTab !== 'my') return;
            dom.driveGrid.innerHTML = '';
            let hasItems = false;

            // 1. Filter and Render Folders
            Object.entries(cachedFolders).forEach(([fid, folder]) => {
                // If currentFolder is root, show folders with parentId == 'root' OR undefined
                const parent = folder.parentId || 'root';
                if (parent === currentFolderId) {
                    dom.driveGrid.appendChild(createDriveItem({ ...folder, id: fid }, 'folder'));
                    hasItems = true;
                }
            });

            // 2. Filter and Render Projects (Files)
            Object.entries(cachedProjects).forEach(([pid, project]) => {
                const folder = project.folderId || 'root';
                if (folder === currentFolderId) {
                    dom.driveGrid.appendChild(createDriveItem({ ...project, id: pid }, 'file'));
                    hasItems = true;
                }
            });

            if (!hasItems) dom.emptyState.classList.remove('hidden');
            else dom.emptyState.classList.add('hidden');
        }

        function createDriveItem(item, type) {
            const el = document.createElement('div');
            el.className = 'drive-item group';
            el.draggable = true; // Enable Drag
            el.dataset.id = item.id;
            el.dataset.type = type;
            if (item.owner) el.dataset.owner = item.owner; // For shared

            // Icon Selection
            let iconHtml = '';
            if (type === 'folder') {
                iconHtml = `<span class="material-symbols-outlined icon folder-icon filled-icon">folder</span>`;
                // Drop Target logic
                el.ondragover = (e) => { e.preventDefault(); el.classList.add('folder-drag-over'); };
                el.ondragleave = () => el.classList.remove('folder-drag-over');
                el.ondrop = handleDropOnFolder;
            } else {
                const lang = item.language || 'text';
                const icons = { html: 'html', javascript: 'javascript', css: 'css', python: 'terminal', markdown: 'markdown' };
                const colors = { html: 'html-icon', javascript: 'js-icon', css: 'css-icon', python: 'py-icon', markdown: 'md-icon' };
                iconHtml = `<span class="material-symbols-outlined icon ${colors[lang] || ''}">${icons[lang] || 'description'}</span>`;
            }

            el.innerHTML = `
                ${iconHtml}
                <div class="name" title="${item.name}">${item.name}</div>
                <button class="context-menu-btn text-gray-400 hover:text-white">
                    <span class="material-symbols-outlined">more_vert</span>
                </button>
            `;

            // Interactions
            el.addEventListener('click', (e) => {
                if(e.target.closest('.context-menu-btn')) {
                    showContextMenu(e, item, type);
                } else {
                    if (type === 'folder') enterFolder(item.id, item.name);
                    else openEditor(item.id, item.owner || currentUser.uid);
                }
            });
            
            // Drag Start
            el.addEventListener('dragstart', (e) => {
                e.dataTransfer.setData('text/plain', JSON.stringify({ id: item.id, type: type }));
                e.dataTransfer.effectAllowed = 'move';
            });

            return el;
        }

        // --- DRIVE ACTIONS ---
        function enterFolder(folderId, folderName) {
            currentFolderId = folderId;
            breadcrumbPath.push({ id: folderId, name: folderName });
            renderBreadcrumbs();
            renderGrid();
        }

        async function handleDropOnFolder(e) {
            e.preventDefault();
            this.classList.remove('folder-drag-over');
            const targetFolderId = this.dataset.id;
            
            try {
                const data = JSON.parse(e.dataTransfer.getData('text/plain'));
                if (data.type === 'file') {
                    // Move Project
                    const updates = {};
                    updates[`users/${currentUser.uid}/projects/${data.id}/folderId`] = targetFolderId;
                    await update(ref(db), updates);
                } else if (data.type === 'folder' && data.id !== targetFolderId) {
                    // Move Folder (prevent self-nesting loop needs more check, simpler for now)
                    const updates = {};
                    updates[`users/${currentUser.uid}/folders/${data.id}/parentId`] = targetFolderId;
                    await update(ref(db), updates);
                }
                // FIX: Re-render the grid to reflect the change immediately
                renderGrid();

            } catch (err) {
                console.error("Drop Error", err);
            }
        }

        // --- CRUD OPERATIONS ---
        document.getElementById('new-folder-btn').addEventListener('click', () => {
            showModal({
                title: 'Nueva Carpeta',
                message: 'Introduce el nombre de la carpeta:',
                showInput: true,
                placeholder: 'Ej: Mis Proyectos',
                onConfirm: async (name) => {
                    if (!name) return;
                    const newRef = push(ref(db, `users/${currentUser.uid}/folders`));
                    await set(newRef, {
                        name: name,
                        parentId: currentFolderId,
                        createdAt: new Date().toISOString()
                    });
                }
            });
        });

        document.getElementById('new-project-btn').addEventListener('click', () => {
            showModal({
                title: 'Nuevo Proyecto',
                message: 'Configura tu nuevo proyecto:',
                showInput: true,
                showSelect: true,
                placeholder: 'Nombre del proyecto',
                onConfirm: async (name, lang) => {
                    if (!name) return;
                    const boilerplates = {
                        html: `<!DOCTYPE html>\n<html>\n<head>\n  <title>${name}</title>\n  <script src="https://cdn.tailwindcss.com"><\/script>\n</head>\n<body class="bg-gray-100 p-10">\n  <h1 class="text-3xl font-bold text-blue-600">Hola, ${name}!</h1>\n</body>\n</html>`,
                        javascript: `// ${name}.js\nconsole.log("Hello World");`,
                        css: `/* ${name}.css */\nbody { background: #f0f0f0; }`,
                        python: `def main():\n    print("Hola ${name}")\n\nif __name__ == "__main__":\n    main()`,
                        markdown: `# ${name}\n\nDocumentación del proyecto.`
                    };
                    
                    const newRef = push(ref(db, `users/${currentUser.uid}/projects`));
                    await set(newRef, {
                        name: name,
                        language: lang,
                        code: boilerplates[lang],
                        folderId: currentFolderId,
                        owner: currentUser.uid,
                        ownerName: currentUser.displayName,
                        createdAt: new Date().toISOString()
                    });
                    openEditor(newRef.key, currentUser.uid);
                }
            });
        });

        // --- CONTEXT MENU ---
        let contextItem = null;
        function showContextMenu(e, item, type) {
            e.stopPropagation();
            e.preventDefault();
            contextItem = { ...item, type };
            const menu = dom.contextMenu;
            
            // Positioning
            menu.style.display = 'block';
            menu.style.left = `${e.clientX - 10}px`;
            menu.style.top = `${e.clientY + 10}px`;

            // Close on click outside
            const closeMenu = () => {
                menu.style.display = 'none';
                document.removeEventListener('click', closeMenu);
            };
            document.addEventListener('click', closeMenu);
        }

        document.getElementById('ctx-open').addEventListener('click', () => {
            if (contextItem.type === 'folder') enterFolder(contextItem.id, contextItem.name);
            else openEditor(contextItem.id, contextItem.owner || currentUser.uid);
        });

        document.getElementById('ctx-delete').addEventListener('click', () => {
            if (!contextItem) return;
            const isFolder = contextItem.type === 'folder';
            showModal({
                title: `Eliminar ${isFolder ? 'Carpeta' : 'Archivo'}`,
                message: `¿Seguro que quieres borrar "${contextItem.name}"? ${isFolder ? 'Esto borrará el contenido interno.' : ''}`,
                confirmText: 'Eliminar',
                onConfirm: async () => {
                    const path = isFolder ? `folders/${contextItem.id}` : `projects/${contextItem.id}`;
                    await remove(ref(db, `users/${currentUser.uid}/${path}`));
                    // Note: Deleting a folder properly requires recursively deleting children. 
                    // For this simple version, children will just become "orphaned" or hidden.
                    // A proper implementation would query items with this parentId and delete them.
                }
            });
        });

        document.getElementById('ctx-move').addEventListener('click', () => {
            if(!contextItem) return;
             // Simple Prompt Move
             showModal({
                title: 'Mover a...',
                message: 'Para mover, arrastra y suelta el archivo sobre una carpeta.',
                showInput: false,
                confirmText: 'Entendido'
            });
        });

        // --- EDITOR LOGIC ---
        async function openEditor(pid, ownerId) {
            dom.dashboardView.classList.add('hidden');
            dom.editorView.classList.remove('hidden');
            dom.banner.classList.add('hidden');
            dom.app.style.height = '100vh';
            
            currentProgramId = pid;
            currentProgramOwner = ownerId;
            
            const pRef = ref(db, `users/${ownerId}/projects/${pid}`);
            const snap = await get(pRef);
            if (!snap.exists()) {
                showDashboard(); 
                return;
            }
            const data = snap.val();
            
            dom.editorTitle.textContent = data.name;
            currentLang = data.language;
            
            // UI Toggles
            const isHtml = data.language === 'html';
            dom.previewContainer.style.display = isHtml ? 'block' : 'none';
            dom.editorContainer.classList.toggle('w-full', !isHtml);
            dom.editorContainer.classList.toggle('md:w-1/2', isHtml);
            document.getElementById('preview-new-tab-btn').classList.toggle('hidden', !isHtml);

            // Monaco
            if (monacoEditor) monacoEditor.dispose();
            require.config({ paths: { 'vs': 'https://cdn.jsdelivr.net/npm/monaco-editor@0.44.0/min/vs' }});
            require(['vs/editor/editor.main'], function() {
                monacoEditor = monaco.editor.create(dom.editorContainer, {
                    value: data.code,
                    language: data.language,
                    theme: 'vs-dark',
                    automaticLayout: true,
                    fontSize: 14,
                    padding: { top: 16 },
                    minimap: { enabled: false }
                });

                if (isHtml) dom.previewIframe.srcdoc = data.code;

                // Auto-Save
                let saveTimeout;
                monacoEditor.onDidChangeModelContent(() => {
                    const val = monacoEditor.getValue();
                    if (isHtml) dom.previewIframe.srcdoc = val;
                    document.getElementById('editor-status').textContent = 'Guardando...';
                    
                    clearTimeout(saveTimeout);
                    saveTimeout = setTimeout(async () => {
                         if (currentUser && ownerId === currentUser.uid) { // Only owner saves for now
                             await update(ref(db, `users/${ownerId}/projects/${pid}`), { 
                                 code: val, 
                                 lastEditor: currentUser.uid 
                             });
                             document.getElementById('editor-status').textContent = 'Guardado';
                         }
                    }, 1000);
                });
            });

            // Listen for external changes (Collab)
            onValue(pRef, (snap) => {
                const d = snap.val();
                if (d && monacoEditor && d.lastEditor !== currentUser.uid && d.code !== monacoEditor.getValue()) {
                    const pos = monacoEditor.getPosition();
                    monacoEditor.setValue(d.code);
                    monacoEditor.setPosition(pos);
                }
            });
        }

        document.getElementById('back-to-dashboard').addEventListener('click', showDashboard);
        document.getElementById('logo-btn').addEventListener('click', showDashboard);
        document.getElementById('nav-home-btn').addEventListener('click', showDashboard);
        
        // FIX: Add listener for the "Abrir Web" button
        document.getElementById('preview-new-tab-btn').addEventListener('click', () => {
            // Check if the current language is HTML (only web previews are valid)
            if (currentLang === 'html') {
                // Get the current HTML content from the iframe's srcdoc
                const htmlContent = dom.previewIframe.srcdoc;
                
                // Open a new window/tab
                const newWindow = window.open();
                
                // Write the content to the new window
                if (newWindow) {
                    newWindow.document.write(htmlContent);
                    newWindow.document.close();
                }
            } else {
                showAlert('Previsualización no disponible', 'Solo los proyectos con lenguaje HTML pueden abrirse en una nueva ventana.');
            }
        });

        // --- AI LOGIC (MISTRAL with STREAM) ---
        document.getElementById('ai-prompt').addEventListener('keydown', async (e) => {
            if (e.key === 'Enter') {
                const prompt = e.target.value.trim();
                if (!prompt || !monacoEditor) return;
                
                const isDiff = document.getElementById('ai-diff-mode-checkbox').checked;
                const code = monacoEditor.getValue();
                
                // UI Loading
                e.target.disabled = true;
                document.getElementById('ai-loading-spinner').classList.remove('hidden');

                const msgs = [
                    { role: "system", content: isDiff ? SYSTEM_PROMPT_DIFF : SYSTEM_PROMPT_REPLACE(currentLang) },
                    { role: "user", content: `Code:\n${code}\n\nRequest: ${prompt}` }
                ];

                try {
                    const res = await fetch('https://text.pollinations.ai/openai?token=25eMuLLjvFlPA9iw', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            model: 'gemini', 
                            messages: msgs,
                            stream: true // Enable Streaming
                        })
                    });

                    // Prepare for streaming
                    const reader = res.body.getReader();
                    const decoder = new TextDecoder();
                    let fullContent = '';
                    
                    // If not diff, clear editor to "stream" replacement
                    if (!isDiff) monacoEditor.setValue(''); 

                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;
                        
                        const chunk = decoder.decode(value, { stream: true });
                        const lines = chunk.split('\n');
                        
                        for (const line of lines) {
                            if (line.startsWith('data: ')) {
                                const dataStr = line.substring(6).trim();
                                if (dataStr === '[DONE]') break;
                                try {
                                    const json = JSON.parse(dataStr);
                                    const delta = json.choices[0].delta.content;
                                    if (delta) {
                                        fullContent += delta;
                                        // Update Editor Live
                                        if (!isDiff) {
                                            // Cleaning markdown fences live is tricky, so we stream raw first
                                            // Or simplified: just update value. 
                                            // A robust live stream would wait for fences, but for speed:
                                            const clean = fullContent.replace(/```[a-z]*\n?|```/g, '');
                                            monacoEditor.setValue(clean);
                                            // Auto-scroll to bottom
                                            monacoEditor.revealLine(monacoEditor.getModel().getLineCount());
                                        }
                                    }
                                } catch (e) { /* ignore parse error on chunks */ }
                            }
                        }
                    }
                    
                    // FIX: Ensure the final, complete content is set after the stream ends 
                    // (only in non-diff/replace mode, as diff mode uses a modal).
                    if (!isDiff) {
                        const cleanedFinalContent = fullContent.replace(/```[a-z]*\n?|```/g, '').trim();
                        monacoEditor.setValue(cleanedFinalContent);
                    }

                    // Final processing
                    if (isDiff) {
                        let content = fullContent.replace(/```json|```/g, '').trim();
                        const changes = JSON.parse(content);
                        showModal({
                            title: 'Revisión IA',
                            message: `La IA sugiere ${changes.length} cambios.`,
                            diffChanges: changes,
                            confirmText: 'Aplicar',
                            onConfirm: () => {
                                let newCode = code;
                                changes.forEach(c => newCode = newCode.replace(c.originalLine, c.editedLine));
                                monacoEditor.setValue(newCode);
                            }
                        });
                    }

                } catch (err) {
                    console.error(err);
                    showAlert('Error IA', 'No se pudo procesar la solicitud.');
                } finally {
                    e.target.disabled = false;
                    e.target.value = '';
                    e.target.focus();
                    document.getElementById('ai-loading-spinner').classList.add('hidden');
                }
            }
        });

        document.getElementById('ai-settings-toggle').addEventListener('click', () => {
            document.getElementById('ai-settings-dropdown').classList.toggle('hidden');
        });

        // --- GENERIC MODAL UI ---
        function showModal({ title, message, showInput = false, showSelect = false, placeholder = '', confirmText = 'Aceptar', cancelText = 'Cancelar', onConfirm, diffChanges = null }) {
            const m = dom.modal;
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-message').textContent = message;
            
            const formContainer = document.getElementById('modal-form-container');
            const input = document.getElementById('modal-input');
            const select = document.getElementById('modal-select');
            
            if (showInput || showSelect) {
                formContainer.classList.remove('hidden');
                input.classList.toggle('hidden', !showInput);
                select.classList.toggle('hidden', !showSelect);
                input.value = '';
                input.placeholder = placeholder;
            } else {
                formContainer.classList.add('hidden');
            }

            // Diff View
            const diffContainer = document.getElementById('modal-diff-container');
            const diffContent = document.getElementById('modal-diff-content');
            if (diffChanges) {
                diffContainer.classList.remove('hidden');
                diffContent.innerHTML = diffChanges.map(c => 
                    `<div class="text-red-400">- ${c.originalLine}</div><div class="text-green-400">+ ${c.editedLine}</div>`
                ).join('<br>');
            } else {
                diffContainer.classList.add('hidden');
            }

            const confirmBtn = document.getElementById('modal-confirm-btn');
            const cancelBtn = document.getElementById('modal-cancel-btn');
            
            confirmBtn.textContent = confirmText;
            cancelBtn.textContent = cancelText;

            // Handlers
            const handleConfirm = () => {
                m.classList.add('hidden');
                if (onConfirm) onConfirm(input.value, select.value);
                cleanup();
            };
            const handleCancel = () => {
                m.classList.add('hidden');
                cleanup();
            };
            const cleanup = () => {
                confirmBtn.removeEventListener('click', handleConfirm);
                cancelBtn.removeEventListener('click', handleCancel);
            };

            confirmBtn.addEventListener('click', handleConfirm);
            cancelBtn.addEventListener('click', handleCancel);
            m.classList.remove('hidden');
            if (showInput) input.focus();
        }

        function showAlert(title, message) {
            showModal({ title, message, showInput: false });
        }
        
    </script>
</body>
</html>
